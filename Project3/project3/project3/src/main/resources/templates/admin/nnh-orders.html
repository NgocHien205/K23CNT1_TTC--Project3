<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/nnh-layout :: head}"></head>
<body>
<nav th:replace="~{admin/nnh-layout :: nav}"></nav>

<div class="container mt-4">
    <h4 class="text-primary mb-3"><i class="fa-solid fa-file-invoice-dollar"></i> Quản lý Đơn hàng</h4>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="table-head-custom text-white">
                <tr>
                    <th class="py-3 ps-3">Mã Đơn</th>
                    <th class="py-3">Khách hàng</th>
                    <th class="py-3">Ngày đặt</th>
                    <th class="py-3">Tổng tiền</th>
                    <th class="py-3">Trạng thái</th>
                    <th class="py-3">Thao tác</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="o : ${nnhOrders}">
                    <td class="fw-bold ps-3" th:text="${'#' + o.nnhId}"></td>

                    <td th:text="${o.nnhUser != null ? o.nnhUser.nnhFullName : 'Unknown'}"></td>

                    <td th:text="${#dates.format(o.nnhOrderDate, 'dd/MM/yyyy HH:mm')}"></td>

                    <td class="fw-bold text-danger"
                        th:text="${#numbers.formatDecimal(o.nnhTotalAmount, 0, 'COMMA', 0, 'POINT') + ' đ'}">
                    </td>

                    <td>
                        <span th:if="${o.nnhStatus == 'PENDING'}" class="badge bg-warning text-dark">Chờ duyệt</span>
                        <span th:if="${o.nnhStatus == 'SHIPPED'}" class="badge bg-info text-dark">Đang giao</span>
                        <span th:if="${o.nnhStatus == 'COMPLETED'}" class="badge bg-success">Hoàn thành</span>
                        <span th:if="${o.nnhStatus == 'CANCELLED'}" class="badge bg-danger">Đã hủy</span>
                    </td>

                    <td>
                        <a th:href="@{/admin/orders/{id}(id=${o.nnhId})}" class="btn btn-sm btn-primary">
                            <i class="fa-solid fa-eye"></i> Chi tiết
                        </a>
                        <button class="btn btn-sm btn-outline-danger" th:onclick="'deleteOrder(' + ${o.nnhId} + ')'">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg"> <div class="modal-content">
        <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Chi tiết Đơn hàng #<span id="modalOrderId"></span></h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <p><strong>Khách hàng:</strong> <span id="modalCustomer"></span></p>
                    <p><strong>Ngày đặt:</strong> <span id="modalDate"></span></p>
                </div>
                <div class="col-md-6 text-end">
                    <p><strong>Trạng thái hiện tại:</strong> <span id="modalStatus" class="fw-bold"></span></p>
                    <div class="input-group">
                        <select id="statusSelect" class="form-select">
                            <option value="PENDING">PENDING (Chờ duyệt)</option>
                            <option value="SHIPPED">SHIPPED (Đang giao)</option>
                            <option value="COMPLETED">COMPLETED (Hoàn thành)</option>
                            <option value="CANCELLED">CANCELLED (Hủy bỏ)</option>
                        </select>
                        <button class="btn btn-success" onclick="updateStatus()">Cập nhật</button>
                    </div>
                </div>
            </div>

            <h6 class="border-bottom pb-2">Danh sách sản phẩm</h6>
            <table class="table table-bordered">
                <thead class="table-light">
                <tr>
                    <th>Sản phẩm</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Thành tiền</th>
                </tr>
                </thead>
                <tbody id="modalOrderDetailsBody">
                </tbody>
                <tfoot>
                <tr>
                    <td colspan="3" class="text-end fw-bold">TỔNG CỘNG:</td>
                    <td class="fw-bold text-danger" id="modalTotal"></td>
                </tr>
                </tfoot>
            </table>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
    </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const orderModal = new bootstrap.Modal(document.getElementById('orderModal'));
    let currentOrderId = null;

    // Hàm định dạng tiền tệ VNĐ
    const formatMoney = (amount) => {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    };

    // 1. Xem chi tiết đơn hàng
    function viewOrder(id) {
        currentOrderId = id;
        document.getElementById('modalOrderId').innerText = id;

        // Gọi API lấy thông tin chi tiết
        fetch('/api/admin/nnh-orders/' + id)
        .then(res => res.json())
        .then(order => {
            // Điền thông tin chung
            document.getElementById('modalCustomer').innerText = order.nnhUser ? order.nnhUser.nnhFullName : 'Unknown';
            document.getElementById('modalDate').innerText = new Date(order.nnhOrderDate).toLocaleString();
            document.getElementById('modalStatus').innerText = order.nnhStatus;
            document.getElementById('statusSelect').value = order.nnhStatus;
            document.getElementById('modalTotal').innerText = formatMoney(order.nnhTotalAmount);

            // Điền bảng chi tiết sản phẩm
            const tbody = document.getElementById('modalOrderDetailsBody');
            tbody.innerHTML = ""; // Xóa cũ

            if(order.nnhOrderDetails) {
                order.nnhOrderDetails.forEach(item => {
                    const row = `
                        <tr>
                            <td>${item.nnhProduct.nnhName}</td>
                            <td class="text-center">${item.nnhQuantity}</td>
                            <td>${formatMoney(item.nnhPriceAtPurchase)}</td>
                            <td>${formatMoney(item.nnhPriceAtPurchase * item.nnhQuantity)}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            orderModal.show();
        })
        .catch(err => alert("Lỗi tải chi tiết đơn hàng!"));
    }

    // 2. Cập nhật trạng thái
    function updateStatus() {
        const newStatus = document.getElementById('statusSelect').value;
        if(!currentOrderId) return;

        fetch(`/api/admin/nnh-orders/${currentOrderId}/status?newStatus=${newStatus}`, {
            method: 'PUT'
        })
        .then(res => {
            if(res.ok) {
                alert("Cập nhật trạng thái thành công!");
                location.reload();
            } else {
                alert("Lỗi cập nhật!");
            }
        });
    }

    // 3. Xóa đơn hàng
    function deleteOrder(id) {
        if(confirm("Xóa đơn hàng này sẽ mất hết dữ liệu lịch sử. Bạn chắc chắn?")) {
            fetch('/api/admin/nnh-orders/' + id, { method: 'DELETE' })
            .then(res => {
                if(res.ok) location.reload();
                else alert("Lỗi khi xóa!");
            });
        }
    }
</script>
</body>
</html>